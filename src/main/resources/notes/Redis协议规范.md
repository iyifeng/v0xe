### RESP协议规范

RESP:Redis Serialization Protocol协议，它是一个二进制安全的，不需要讲大量数据从一个进程传输到另一个进程，使用前缀长度来传输数据块。

RESP整体上是一个简单的请求-响应协议，除了一下特殊情况

1. Redis支持流水线操作，客户端可以一次发送多条命令，并等待服务端的响应
2. 当Redis订阅了一个频道，协议会改变语义，变成一个推送协议，客户端不再需要发送命令，因为服务端一旦收到请求消息会自动发送响应消息到客户端订阅的频道上，客户端从该频道上读取消息，类似一个发布/订阅模型。

#### RESP协议说明

RESP是一个序列化协议，支持以下数据类型：

1. 简单字符串，以"+"开头，CRLF结尾

```
"+OK\r\n"
```

2. 错误类型，以"-"开头，CRLF结尾

```
"-Error message\r\n"
```

3. 整型 ，以":"开头，CRLF结尾

```
":1000\r\n"
```

4. 块字符串，以"$"+长度+CRLF开头，CRLF结尾，大容量字符串用来表示一个单一的二进制安全字符串，最大512M
   1. 以"$"开头，紧跟着的是块字符串的长度，然后是\r\n
   2. 实际的块字符串数据
   3. 结尾标识\r\n

```
"$6\r\nfoobar\r\n"
```

空字符串

```
"$0\r\n\r\n"
```

还可以表示空值(Null)或不存在的值，但是客户端API不应该返回一个空字符串，而是返回一个nil对象

```
"$-1\r\n"
```

5. RESP数组，以"*"+数组长度+CRLF开头，后面的数字表示数组中元素个数，每个元素都是RESP支持的类型，以CRLF结尾

```
"*0\r\n" 表示空数组
```

```
"*2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n" 表示包含两个大容量字符串"foo"和"bar"的数组
```

```
"*3\r\n:1\r\n:2\r\n:3\r\n" 表示三个整型的数组
```

```
*5\r\n
:1\r\n
:2\r\n
:3\r\n
:4\r\n
$6\r\n
foobar\r\n 表示混合类型数组，为了便于理解，分成了多行来表示，实际中是一行
```

```
"*-1\r\n" 表示空数组，如当BLPOP命令超时时，将返回一个计数值为-1的空数组
```

```
*2\r\n
*3\r\n
:1\r\n
:2\r\n
:3\r\n
*2\r\n
+Foo\r\n
-Bar\r\n 表示一个嵌套数组，第二个数组的元素包含一个简单字符串和一个错误
```

```
*3\r\n
$3\r\n
foo\r\n
$-1\r\n  这里是数组中的第二个元素，表示一个空值
$3\r\n
bar\r\n  此时，客户端的返回值应该是 ["foo",nil,"bar"]
```

#### 客户端与服务端交互

1. Redis客户端向Redis服务端发送大字符串组成的RESP数组

2. Redis服务端向客户端回复RESP数据

   客户端发送查询列表长度的命令LLEN mylist，实际交互如下：

```
C: *2\r\n
C: $4\r\n
C: LLEN\r\n
C: $6\r\n
C: mylist\r\n

S: :48293\r\n 为了便于理解，这里进行了换行，实际客户端发送的是*2\r\n$4\r\nLLEN\r\n$6\r\nmylist\r\n
```

